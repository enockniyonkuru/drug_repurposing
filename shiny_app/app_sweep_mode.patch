# Patch for Adding Sweep Mode Visualization to Shiny App
# Apply these changes to shiny_app/app.R

## CHANGE 1: Add sweep mode reactive values (around line 450)
## Location: In the reactiveValues() initialization

# ADD these new fields to values <- reactiveValues():
    drp_object = NULL,
    is_sweep_mode = FALSE,
    sweep_robust_hits = NULL,
    sweep_cutoff_summary = NULL,
    sweep_img_dir = NULL

## CHANGE 2: Update run_single_analysis() function
## Location: Around line 850, at the end of run_single_analysis()

# REPLACE this section (after drp$run_single() or drp$run_sweep()):
        values$results <- drp$drugs
        values$drugs_valid <- drp$drugs_valid

# WITH:
        # Store the DRP object to access sweep results
        values$drp_object <- drp
        values$is_sweep_mode <- (drp$mode == "sweep")
        
        # For sweep mode, capture sweep-specific results
        if (values$is_sweep_mode) {
          values$sweep_robust_hits <- drp$robust_hits
          values$sweep_cutoff_summary <- drp$cutoff_summary
          values$sweep_img_dir <- file.path(drp$out_dir, "img")
          
          # Use robust_hits as drugs_valid for compatibility
          if (!is.null(drp$robust_hits) && nrow(drp$robust_hits) > 0) {
            values$drugs_valid <- data.frame(
              name = drp$robust_hits$name,
              cmap_score = drp$robust_hits$aggregated_score,
              q = drp$robust_hits$min_q,
              n_support = drp$robust_hits$n_support,
              stringsAsFactors = FALSE
            )
          }
        } else {
          # Single mode: use drugs_valid as normal
          values$results <- drp$drugs
          values$drugs_valid <- drp$drugs_valid
        }

## CHANGE 3: Add Sweep Results Header
## Location: After output$plotsHeader (around line 1100)

# ADD:
  # Sweep results header
  output$sweepResultsHeader <- renderUI({
    if (values$is_sweep_mode) {
      p(icon("layer-group"), strong(" Sweep Mode Results - "), 
        "Robust hits across multiple thresholds")
    } else {
      p(icon("info-circle"), " Sweep results are only available in Sweep Mode")
    }
  })

## CHANGE 4: Add Sweep Results UI
## Location: After output$plotsUI (around line 1200)

# ADD:
  # Dynamic sweep results UI
  output$sweepResultsUI <- renderUI({
    if (!values$is_sweep_mode) {
      return(fluidRow(
        box(
          title = "Not Applicable",
          width = 12,
          status = "warning",
          p("Sweep results are only available when running in Sweep Mode."),
          p("To use sweep mode, select 'Sweep Mode' in the configuration step.")
        )
      ))
    }
    
    if (is.null(values$sweep_robust_hits)) {
      return(fluidRow(
        box(
          title = "No Results",
          width = 12,
          status = "info",
          p("No sweep results available. Please run an analysis first.")
        )
      ))
    }
    
    fluidRow(
      valueBoxOutput("sweepTotalHitsBox"),
      valueBoxOutput("sweepCutoffsTestedBox"),
      valueBoxOutput("sweepTopDrugBox"),
      
      box(
        title = "Robust Drug Hits (Passed Filtering Across Thresholds)",
        width = 12,
        status = "success",
        solidHeader = TRUE,
        p(paste("These drugs appeared consistently across multiple log2FC thresholds,",
                "indicating robust repurposing candidates.")),
        downloadButton("downloadSweepRobustHits", "Download Robust Hits CSV"),
        hr(),
        DTOutput("sweepRobustHitsTable")
      ),
      
      box(
        title = "Threshold Performance Summary",
        width = 12,
        status = "info",
        solidHeader = TRUE,
        p("Performance metrics for each log2FC threshold tested in sweep mode."),
        DTOutput("sweepCutoffSummaryTable")
      ),
      
      box(
        title = "Sweep Analysis Plots",
        width = 12,
        status = "primary",
        solidHeader = TRUE,
        p("Plots generated during sweep mode analysis:"),
        uiOutput("sweepPlotsDisplay")
      )
    )
  })

## CHANGE 5: Add Sweep Results Outputs
## Location: After the download handlers (around line 1400)

# ADD:
  # Sweep mode value boxes
  output$sweepTotalHitsBox <- renderValueBox({
    hits <- if (!is.null(values$sweep_robust_hits)) nrow(values$sweep_robust_hits) else 0
    valueBox(hits, "Robust Hits", icon = icon("pills"), 
            color = if(hits > 0) "green" else "red")
  })
  
  output$sweepCutoffsTestedBox <- renderValueBox({
    cutoffs <- if (!is.null(values$sweep_cutoff_summary)) nrow(values$sweep_cutoff_summary) else 0
    valueBox(cutoffs, "Thresholds Tested", icon = icon("sliders-h"), color = "blue")
  })
  
  output$sweepTopDrugBox <- renderValueBox({
    top <- if (!is.null(values$sweep_robust_hits) && nrow(values$sweep_robust_hits) > 0) {
      values$sweep_robust_hits$name[1]
    } else "None"
    valueBox(top, "Top Drug", icon = icon("star"), color = "purple")
  })
  
  # Sweep results tables
  output$sweepRobustHitsTable <- renderDT({
    req(values$sweep_robust_hits)
    datatable(values$sweep_robust_hits, 
             options = list(scrollX = TRUE, pageLength = 25), 
             filter = 'top')
  })
  
  output$sweepCutoffSummaryTable <- renderDT({
    req(values$sweep_cutoff_summary)
    datatable(values$sweep_cutoff_summary, 
             options = list(scrollX = TRUE, pageLength = 10))
  })
  
  # Display generated plots
  output$sweepPlotsDisplay <- renderUI({
    req(values$sweep_img_dir)
    
    if (!dir.exists(values$sweep_img_dir)) {
      return(p("Plot directory not found."))
    }
    
    plot_files <- list.files(values$sweep_img_dir, 
                            pattern = "\\.(jpg|jpeg|png)$", 
                            full.names = TRUE)
    
    if (length(plot_files) == 0) {
      return(p("No plots were generated."))
    }
    
    # Create image outputs for each plot
    plot_outputs <- lapply(seq_along(plot_files), function(i) {
      output_name <- paste0("sweepPlot", i)
      output[[output_name]] <- renderImage({
        list(src = plot_files[i],
             contentType = 'image/jpeg',
             width = "100%",
             alt = basename(plot_files[i]))
      }, deleteFile = FALSE)
      
      box(
        title = basename(plot_files[i]),
        width = 6,
        status = "primary",
        imageOutput(output_name)
      )
    })
    
    do.call(fluidRow, plot_outputs)
  })
  
  # Download handler for sweep robust hits
  output$downloadSweepRobustHits <- downloadHandler(
    filename = function() {
      paste("sweep_robust_hits_", Sys.Date(), ".csv", sep = "")
    },
    content = function(file) {
      req(values$sweep_robust_hits)
      write.csv(values$sweep_robust_hits, file, row.names = FALSE)
    }
  )

## SUMMARY OF CHANGES:
## 1. Added 5 new reactive values for sweep mode data
## 2. Modified run_single_analysis() to capture sweep results
## 3. Added sweepResultsHeader output
## 4. Added sweepResultsUI output with complete UI
## 5. Added 9 new outputs for sweep mode visualization

## The Sweep Results tab (already in UI) will now display:
## - Summary value boxes (hits, thresholds tested, top drug)
## - Robust hits table with filtering
## - Cutoff summary table
## - Generated plot images from the analysis
