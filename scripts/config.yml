# Drug Repurposing Pipeline Configuration
# This configuration supports three main functionalities:
# 1. Run a single profile (runall.R)
# 2. Compare multiple profiles (compare_profiles.R)
# 3. Sweep mode analysis (runall.R with sweep mode enabled)

# Execution configuration - specify which profiles/operations to run
execution:
  # Profile to use for runall.R (single profile execution)
  runall_profile: "Endothelial_Strict"

  # Profiles to compare in compare_profiles.R
  compare_profiles: ["Endothelial_Strict", "Endothelial_Standard", "Endothelial_Lenient"]

# ============================================================================
# DEFAULT PROFILE (REQUIRED - DO NOT DELETE)
# ============================================================================
# This profile is required by the R config package as a technical requirement.
# 
# IMPORTANT: Do NOT modify this default profile directly!
# Instead, create a COPY of it with a new name for your custom analyses.
# The default profile should always remain in the config file.
#
# To create your own profile:
# 1. Copy this entire default section
# 2. Rename it (e.g., "MyAnalysis", "Project1_Strict", etc.)
# 3. Modify the paths and parameters in YOUR copy
# 4. Reference your new profile name in execution: runall_profile:
# ============================================================================
default:
  paths:
    # Path to CMap reference signatures database (RData file)
    # This file contains the drug-induced gene expression signatures
    # REQUIRED: Must be downloaded separately (see README Section 3.1)
    signatures: "data/cmap_signatures.RData"
    
    # Path to YOUR disease gene expression signature (CSV file)
    # Must contain: gene identifiers + log2 fold-change values
    # IMPORTANT: Verify your CSV has column headers! Missing headers is a common issue.
    disease_file: "data/CoreFibroidSignature_All_Datasets.csv"
    
    # Path to CMap experiment metadata (optional but recommended)
    # Contains drug names, cell lines, experimental conditions
    cmap_meta: "data/cmap_drug_experiments_new.csv"
    
    # Path to CMap valid instances list (optional but recommended)
    # Contains curated list of valid experiments with DrugBank IDs
    cmap_valid: "data/cmap_valid_instances.csv"
    
    # Output directory for results (relative to scripts/ folder)
    out_dir: "results"
    
  params:
    # ---- Gene Identifier Settings ----
    # Column name in YOUR disease file containing gene identifiers
    # Common values: "SYMBOL", "Gene", "gene_name", "ENSEMBL", "ENTREZ"
    # IMPORTANT: Must match the actual column name in your CSV file exactly
    gene_key: "SYMBOL"
    
    # Prefix for log2 fold-change columns in YOUR disease file
    # If you have columns like "log2FC_1", "log2FC_2", use "log2FC"
    # If you have columns like "fc_rep1", "fc_rep2", use "fc_"
    logfc_cols_pref: "log2FC"
    
    # ---- Filtering Thresholds ----
    # Absolute log2 fold-change threshold for gene filtering
    # Genes with |log2FC| >= this value are considered differentially expressed
    # Typical values: 0.5 (lenient), 1.0 (standard), 1.5 (strict)
    logfc_cutoff: 0.5
    
    # Column name for p-values/adjusted p-values in YOUR disease file
    # Set to null to skip p-value filtering (use fold-change only)
    # Common values: "p_val_adj", "FDR", "pvalue", "padj", or null
    pval_key: null
    
    # P-value threshold for filtering genes (only used if pval_key is not null)
    # Genes with p-value <= this value are kept
    # Typical values: 0.05 (standard), 0.01 (strict), 0.1 (lenient)
    pval_cutoff: 0.05
    
    # ---- Drug Significance Threshold ----
    # FDR (q-value) threshold for determining significant drug hits
    # Drugs with q-value <= this value are considered significant
    # Typical value: 0.05 (5% false discovery rate)
    q_thresh: 0.05
    
    # ---- Drug Filtering ----
    # Keep only drugs that REVERSE the disease signature (negative connectivity)
    # true = keep only reversal drugs (recommended for drug repurposing)
    # false = keep all drugs (both reversal and mimicking)
    reversal_only: true
    
    # Random seed for reproducibility
    # Use the same seed to get identical results across runs
    seed: 123
    
    # ---- Analysis Mode ----
    # "single" = standard analysis with one fold-change cutoff
    # "sweep" = test multiple cutoffs to find robust drug candidates
    mode: "single"
    
    # ---- Multi-Column Handling ----
    # How to combine multiple log2FC columns (if your data has replicates)
    # "average" = take mean of all columns (recommended)
    # "median" = take median of all columns (robust to outliers)
    # "first" = use only the first column (ignore others)
    # For single-column data, this parameter is ignored
    combine_log2fc: "average"
    
    # ---- Sweep Mode Parameters (only used when mode: "sweep") ----
    # Specific fold-change cutoffs to test, or null for auto-generation
    # Example: [0.5, 1.0, 1.5] or null
    sweep_cutoffs: null
    
    # Auto-generate cutoff grid based on data distribution
    sweep_auto_grid: true
    
    # Step size for auto-generated cutoffs (e.g., 0.1 means 0.5, 0.6, 0.7...)
    sweep_step: 0.1
    
    # Minimum fraction of genes required at each cutoff (e.g., 0.20 = 20%)
    sweep_min_frac: 0.20
    
    # Minimum absolute number of genes required at each cutoff
    sweep_min_genes: 200
    
    # Stop sweep if signature becomes too small
    sweep_stop_on_small: false
    
    # Rule for determining "robust" drugs across cutoffs
    # "all" = drug must be significant at ALL cutoffs
    # "k_of_n" = drug must be significant in at least k cutoffs
    robust_rule: "all"
    
    # Minimum number of cutoffs required (only used if robust_rule: "k_of_n")
    # Example: robust_k: 2 means drug must appear in at least 2 cutoffs
    robust_k: null
    
    # How to aggregate scores across cutoffs in sweep mode
    # "mean" = average score across cutoffs
    # "median" = median score across cutoffs (robust to outliers)
    # "weighted_mean" = weighted average (requires weights parameter)
    aggregate: "mean"
    
    # Weights for weighted aggregation (only used if aggregate: "weighted_mean")
    # Example: [1, 2, 1] to weight middle cutoff more heavily
    weights: null


# Strict p-value threshold profile
Endothelial_Strict:
  paths:
    signatures: "data/cmap_signatures.RData"
    disease_file: "data/Endothelia_DEG.csv"
    cmap_meta: "data/cmap_drug_experiments_new.csv"
    cmap_valid: "data/cmap_valid_instances.csv"
    out_dir: "results"
  params:
    gene_key: "SYMBOL"
    logfc_cols_pref: "avg_log2FC"
    logfc_cutoff: 0.25
    pval_key: p_val_adj
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"

# Standard p-value threshold profile
Endothelial_Standard:
  paths:
    signatures: "data/cmap_signatures.RData"
    disease_file: "data/Endothelia_DEG.csv"
    cmap_meta: "data/cmap_drug_experiments_new.csv"
    cmap_valid: "data/cmap_valid_instances.csv"
    out_dir: "results"
  params:
    gene_key: "SYMBOL"
    logfc_cols_pref: "avg_log2FC"
    logfc_cutoff: 0.05
    pval_key: p_val_adj
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"

# Lenient p-value threshold profile
Endothelial_Lenient:
  paths:
    signatures: "data/cmap_signatures.RData"
    disease_file: "data/Endothelia_DEG.csv"
    cmap_meta: "data/cmap_drug_experiments_new.csv"
    cmap_valid: "data/cmap_valid_instances.csv"
    out_dir: "results"
  params:
    gene_key: "SYMBOL"
    logfc_cols_pref: "avg_log2FC"
    logfc_cutoff: 1       # Very relaxed fold-change threshold
    pval_key: p_val_adj
    pval_cutoff: 0.1
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"

# Standard profile with logFC cutoff of 1.0
CoreFibroid_logFC_1:
  paths:
    signatures: "data/cmap_signatures.RData"
    disease_file: "data/CoreFibroidSignature_All_Datasets.csv"
    cmap_meta: "data/cmap_drug_experiments_new.csv"
    cmap_valid: "data/cmap_valid_instances.csv"
    out_dir: "results"
  params:
    gene_key: "SYMBOL"
    logfc_cols_pref: "log2FC"
    logfc_cutoff: 1
    pval_key: null           # Column name for p-values (e.g., "p_val_adj", "FDR"). Set to null to skip p-value filtering
    pval_cutoff: 0.05        # P-value threshold for filtering genes (only used if pval_key is not null)
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"
    sweep_cutoffs: null
    sweep_min_frac: 0.20
    sweep_min_genes: 200
    combine_log2fc: "average"
    robust_rule: "all"
    robust_k: null
    aggregate: "mean"
    weights: null

# Lenient profile with lower fold-change cutoff for comparison
CoreFibroid_logFC_0.5:
  paths:
    signatures: "data/cmap_signatures.RData"
    disease_file: "data/CoreFibroidSignature_All_Datasets.csv"
    cmap_meta: "data/cmap_drug_experiments_new.csv"
    cmap_valid: "data/cmap_valid_instances.csv"
    out_dir: "results"
  params:
    gene_key: "SYMBOL"
    logfc_cols_pref: "log2FC"
    logfc_cutoff: 0.5        # More lenient: lower fold-change cutoff
    pval_key: null           # Column name for p-values (e.g., "p_val_adj", "FDR"). Set to null to skip p-value filtering
    pval_cutoff: 0.05        # P-value threshold for filtering genes (only used if pval_key is not null)
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"
    sweep_cutoffs: null
    sweep_min_frac: 0.20
    sweep_min_genes: 200
    combine_log2fc: "average"
    robust_rule: "all"
    robust_k: null
    aggregate: "mean"
    weights: null

# Strict profile with more stringent thresholds for comparison
CoreFibroid_logFC_1.5:
  paths:
    signatures: "data/cmap_signatures.RData"
    disease_file: "data/CoreFibroidSignature_All_Datasets.csv"
    cmap_meta: "data/cmap_drug_experiments_new.csv"
    cmap_valid: "data/cmap_valid_instances.csv"
    out_dir: "results"
  params:
    gene_key: "SYMBOL"
    logfc_cols_pref: "log2FC"
    logfc_cutoff: 1.5        # More stringent: higher fold-change cutoff
    pval_key: null           # Column name for p-values (e.g., "p_val_adj", "FDR"). Set to null to skip p-value filtering
    pval_cutoff: 0.05        # P-value threshold for filtering genes (only used if pval_key is not null)
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"
    sweep_cutoffs: null
    sweep_min_frac: 0.20
    sweep_min_genes: 200
    combine_log2fc: "average"
    robust_rule: "all"
    robust_k: null
    aggregate: "mean"
    weights: null

# Example sweep mode profile - tests multiple cutoffs for robust results
Sweep_CoreFibroid:
  paths:
    signatures: "data/cmap_signatures.RData"
    disease_file: "data/CoreFibroidSignature_All_Datasets.csv"
    cmap_meta: "data/cmap_drug_experiments_new.csv"
    cmap_valid: "data/cmap_valid_instances.csv"
    out_dir: "results"
  params:
    gene_key: "SYMBOL"
    logfc_cols_pref: "log2FC"
    logfc_cutoff: 1              # Base cutoff (not used in sweep mode)
    pval_key: null               # Column name for p-values (e.g., "p_val_adj", "FDR"). Set to null to skip p-value filtering
    pval_cutoff: 0.05            # P-value threshold for filtering genes (only used if pval_key is not null)
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    # Sweep mode configuration
    mode: "sweep"                # Enable sweep mode
    sweep_cutoffs: null          # Let auto-derive from data
    sweep_auto_grid: true        # Auto-derive threshold grid
    sweep_step: 0.6             # Step size for auto-grid
    sweep_min_frac: 0.10         # Minimum 10% of genes
    sweep_min_genes: 150         # Minimum 150 genes
    sweep_stop_on_small: false   # Continue sweep even if signature becomes small
    combine_log2fc: "average"    # Average multiple log2FC columns
    robust_rule: "k_of_n"        # Require presence in k of n cutoffs
    robust_k: 2                  # Must appear in at least 2 cutoffs
    aggregate: "median"          # Use median for aggregation
    weights: null                # No weighting



# Production profile template (customize paths/thresholds as needed)
production:
  paths:
    signatures: "/data/cmap_signatures.RData"
    disease_dir: "/data/disease/"
    disease_pattern: "Fibroid.*\\.csv"
    cmap_meta: "/data/cmap_drug_experiments_new.csv"
    cmap_valid: "/data/cmap_valid_instances.csv"
    out_dir: "/results/drugrep"
  params:
    gene_key: "SYMBOL"
    logfc_cols_pref: "log2FC"
    logfc_cutoff: 1
    pval_key: null               # Column name for p-values (e.g., "p_val_adj", "FDR"). Set to null to skip p-value filtering
    pval_cutoff: 0.05            # P-value threshold for filtering genes (only used if pval_key is not null)
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"
    sweep_cutoffs: null
    sweep_min_frac: 0.20
    sweep_min_genes: 200
    combine_log2fc: "average"
    robust_rule: "all"
    robust_k: null
    aggregate: "mean"
    weights: null
