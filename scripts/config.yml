# Drug Repurposing Pipeline Configuration
# This configuration supports three main functionalities:
# 1. Run a single profile (runall.R)
# 2. Compare multiple profiles (compare_profiles.R)
# 3. Sweep mode analysis (runall.R with sweep mode enabled)

# Execution configuration - specify which profiles/operations to run
execution:
  # Profile to use for runall.R (single profile execution)
<<<<<<< HEAD
  runall_profile: "CMAP_Acne_Sweep"
=======
  runall_profile: "CMAP_Acne_Lenient"
>>>>>>> tahoe_analysis

  # Profiles to compare in compare_profiles.R
  compare_profiles: ["CMAP_Acne_Lenient", "CMAP_Acne_Standard", "CMAP_Acne_Strict"]

# ============================================================================
# DEFAULT PROFILE (REQUIRED - DO NOT DELETE)
# ============================================================================
# This profile is required by the R config package as a technical requirement.
# 
# IMPORTANT: Do NOT modify this default profile directly!
# Instead, create a COPY of it with a new name for your custom analyses.
# The default profile should always remain in the config file.
#
# To create your own profile:
# 1. Copy this entire default section
# 2. Rename it (e.g., "MyAnalysis", "Project1_Strict", etc.)
# 3. Modify the paths and parameters in YOUR copy
# 4. Reference your new profile name in execution: runall_profile:
# ============================================================================
default:
  paths:
    # Path to CMap reference signatures database (RData file)
    # This file contains the drug-induced gene expression signatures
    # REQUIRED: Must be downloaded separately (see README Section 3.1)
    signatures: "data/drug_signatures/cmap_signatures.RData"
    
    # Path to YOUR disease gene expression signature (CSV file)
    # Must contain: gene identifiers + log2 fold-change values
    # IMPORTANT: Verify your CSV has column headers! Missing headers is a common issue.
    disease_file: "data/disease_signatures/acne_signature.csv"
    
    # Path to drug experiment metadata (optional but recommended)
    # Contains drug names, cell lines, experimental conditions
    drug_meta: "data/drug_signatures/cmap_drug_experiments_new.csv"
    
    # Path to drug valid instances list (optional but recommended)
    # Contains curated list of valid experiments with DrugBank IDs
    drug_valid: "data/drug_signatures/cmap_valid_instances.csv"
    
    # Output directory for results (relative to scripts/ folder)
    out_dir: "results"
    
  params:
    # ---- Gene Identifier Settings ----
    # Column name in YOUR disease file containing gene identifiers
    # Common values: "SYMBOL", "Gene", "gene_name", "ENSEMBL", "ENTREZ"
    # IMPORTANT: Must match the actual column name in your CSV file exactly
    gene_key: "gene_symbol"
    
    # Prefix for log2 fold-change columns in YOUR disease file
    # If you have columns like "log2FC_1", "log2FC_2", use "log2FC"
    # If you have columns like "logfc_dz:459", "logfc_dz:297", use "logfc_dz"
    logfc_cols_pref: "logfc_dz"
    
    # Path to gene conversion table for mapping gene symbols to Entrez IDs
    # Used when gprofiler2 is unavailable or for faster processing
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
    
    # ---- Gene Filtering Options ----
    # Choose ONE filtering method for each profile:
    #
    # Option 1: Fixed logfc cutoff (legacy - disease-independent)
    #   Genes with |log2FC| >= this value are kept
    #   Typical values: 0.10 (lenient), 0.15 (standard), 0.20 (strict)
    #   DOWNSIDE: Different diseases have different gene distributions
    #   - Acne data: max logfc=0.369, so 0.10 gives 29 genes
    #   - Arthritis data: max logfc=0.302, so 0.10 gives 32 genes
    #   - Glaucoma data: max logfc=0.282, so 0.10 gives 27 genes
    logfc_cutoff: null
    
    # Option 2: Percentile-based filtering (RECOMMENDED - disease-adaptive)
    #   Keeps the top N% of genes by absolute logFC within each disease
    #   This ensures consistent gene set size relative to each disease's distribution
    #   ADVANTAGE: Adapts to each disease's actual data distribution
    percentile_filtering:
      enabled: true
      threshold: 25  # Keep top 75% of genes by |logFC| per disease
    
    # Column name for p-values/adjusted p-values in YOUR disease file
    # Set to null to skip p-value filtering (use fold-change only)
    # Common values: "p_val_adj", "FDR", "pvalue", "padj", or null
    pval_key: null
    
    # P-value threshold for filtering genes (only used if pval_key is not null)
    # Genes with p-value <= this value are kept
    # Typical values: 0.05 (standard), 0.01 (strict), 0.1 (lenient)
    pval_cutoff: 0.05
    
    # ---- Drug Significance Threshold ----
    # FDR (q-value) threshold for determining significant drug hits
    # Drugs with q-value <= this value are considered significant
    # Typical value: 0.05 (5% false discovery rate)
    q_thresh: 0.05
    
    # ---- Drug Filtering ----
    # Keep only drugs that REVERSE the disease signature (negative connectivity)
    # true = keep only reversal drugs (recommended for drug repurposing)
    # false = keep all drugs (both reversal and mimicking)
    reversal_only: true
    
    # Random seed for reproducibility
    # Use the same seed to get identical results across runs
    seed: 123
    
    # ---- Analysis Mode ----
    # "single" = standard analysis with one fold-change cutoff
    # "sweep" = test multiple cutoffs to find robust drug candidates
    mode: "single"
    
    # ---- Multi-Column Handling ----
    # How to combine multiple log2FC columns (if your data has replicates)
    # "average" = take mean of all columns (recommended)
    # "median" = take median of all columns (robust to outliers)
    # "first" = use only the first column (ignore others)
    # For single-column data, this parameter is ignored
    combine_log2fc: "average"
    
    # ---- Sweep Mode Parameters (only used when mode: "sweep") ----
    # Specific fold-change cutoffs to test, or null for auto-generation
    # Example: [0.5, 1.0, 1.5] or null
    sweep_cutoffs: null
    
    # Auto-generate cutoff grid based on data distribution
    sweep_auto_grid: true
    
    # Step size for auto-generated cutoffs (e.g., 0.1 means 0.5, 0.6, 0.7...)
    sweep_step: 0.05
    
    # Minimum fraction of genes required at each cutoff (e.g., 0.20 = 20%)
    sweep_min_frac: 0.20
    
    # Minimum absolute number of genes required at each cutoff
    sweep_min_genes: 5
    
    # Stop sweep if signature becomes too small
    sweep_stop_on_small: false
    
    # Rule for determining "robust" drugs across cutoffs
    # "all" = drug must be significant at ALL cutoffs
    # "k_of_n" = drug must be significant in at least k cutoffs
    robust_rule: "all"
    
    # Minimum number of cutoffs required (only used if robust_rule: "k_of_n")
    # Example: robust_k: 2 means drug must appear in at least 2 cutoffs
    robust_k: null
    
    # How to aggregate scores across cutoffs in sweep mode
    # "mean" = average score across cutoffs
    # "median" = median score across cutoffs (robust to outliers)
    # "weighted_mean" = weighted average (requires weights parameter)
    aggregate: "mean"
    
    # Weights for weighted aggregation (only used if aggregate: "weighted_mean")
    # Example: [1, 2, 1] to weight middle cutoff more heavily
    weights: null


# ============================================================================
# ACNE PROFILES (CMAP Database)
# ============================================================================

# Lenient fold-change threshold profile for Acne
CMAP_Acne_Lenient:
  paths:
    signatures: "data/drug_signatures/cmap_signatures.RData"
    disease_file: "data/disease_signatures/acne_signature.csv"
    drug_meta: "data/drug_signatures/cmap_drug_experiments_new.csv"
    drug_valid: "data/drug_signatures/cmap_valid_instances.csv"
    out_dir: "results"
  params:
    gene_key: "gene_symbol"
    logfc_cols_pref: "logfc_dz"
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
<<<<<<< HEAD
    logfc_cutoff: 0.033  # Lenient: ~187 genes (top 50%)
=======
    logfc_cutoff: 0.033 
>>>>>>> tahoe_analysis
    percentile_filtering:
      enabled: false
      threshold: 25
    pval_key: null
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"

# Standard fold-change threshold profile for Acne
CMAP_Acne_Standard:
  paths:
    signatures: "data/drug_signatures/cmap_signatures.RData"
    disease_file: "data/disease_signatures/acne_signature.csv"
    drug_meta: "data/drug_signatures/cmap_drug_experiments_new.csv"
    drug_valid: "data/drug_signatures/cmap_valid_instances.csv"
    out_dir: "results"
  params:
    gene_key: "gene_symbol"
    logfc_cols_pref: "logfc_dz"
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
<<<<<<< HEAD
    logfc_cutoff: 0.051  # Standard: ~94 genes (top 25%)
=======
    logfc_cutoff: 0.055  
>>>>>>> tahoe_analysis
    percentile_filtering:
      enabled: false
      threshold: 50
    pval_key: null
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"

# Strict fold-change threshold profile for Acne
CMAP_Acne_Strict:
  paths:
    signatures: "data/drug_signatures/cmap_signatures.RData"
    disease_file: "data/disease_signatures/acne_signature.csv"
    drug_meta: "data/drug_signatures/cmap_drug_experiments_new.csv"
    drug_valid: "data/drug_signatures/cmap_valid_instances.csv"
    out_dir: "results"
  params:
    gene_key: "gene_symbol"
    logfc_cols_pref: "logfc_dz"
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
<<<<<<< HEAD
    logfc_cutoff: 0.07  # Strict: ~56 genes
=======
    logfc_cutoff: 0.066  
    percentile_filtering:
      enabled: false
      threshold: 50
>>>>>>> tahoe_analysis
    pval_key: null
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"

# Sweep mode profile for Acne - tests multiple fold-change cutoffs
CMAP_Acne_Sweep:
  paths:
    signatures: "data/drug_signatures/cmap_signatures.RData"
    disease_file: "data/disease_signatures/acne_signature.csv"
    drug_meta: "data/drug_signatures/cmap_drug_experiments_new.csv"
    drug_valid: "data/drug_signatures/cmap_valid_instances.csv"
    out_dir: "results"
  params:
    gene_key: "gene_symbol"
    logfc_cols_pref: "logfc_dz"
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
    
    # Optimized for acne data (max |logFC| = 0.202)
    # Smaller step = more cutoffs with intermediate gene counts
    logfc_cutoff: 0.0
    
    percentile_filtering:
      enabled: false
      threshold: 25
    
    pval_key: null
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "sweep"
    combine_log2fc: "average"
    sweep_auto_grid: true
    sweep_step: 0.033            # Gives ~6 cutoffs: 0, 0.033, 0.066, 0.099, 0.132, 0.165, 0.198
    sweep_min_frac: 0.01
    sweep_min_genes: 10          # Need at least 10 genes for statistical power
    sweep_stop_on_small: false
    robust_rule: "k_of_n"
    robust_k: 2                  # Drug must appear in at least 2 cutoffs
    aggregate: "median"
    weights: null


# ============================================================================
# ARTHRITIS PROFILES (CMAP Database)
# ============================================================================

# Lenient fold-change threshold profile for Arthritis
CMAP_Arthritis_Lenient:
  paths:
    signatures: "data/drug_signatures/cmap_signatures.RData"
    disease_file: "data/disease_signatures/arthritis_signature.csv"
    drug_meta: "data/drug_signatures/cmap_drug_experiments_new.csv"
    drug_valid: "data/drug_signatures/cmap_valid_instances.csv"
    out_dir: "results"
  params:
    gene_key: "gene_symbol"
    logfc_cols_pref: "logfc_dz"
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
    logfc_cutoff: 0.024  # Lenient: ~443 genes (top 50%)
    percentile_filtering:
      enabled: false
      threshold: 25
    pval_key: null
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"

# Standard fold-change threshold profile for Arthritis
CMAP_Arthritis_Standard:
  paths:
    signatures: "data/drug_signatures/cmap_signatures.RData"
    disease_file: "data/disease_signatures/arthritis_signature.csv"
    drug_meta: "data/drug_signatures/cmap_drug_experiments_new.csv"
    drug_valid: "data/drug_signatures/cmap_valid_instances.csv"
    out_dir: "results"
  params:
    gene_key: "gene_symbol"
    logfc_cols_pref: "logfc_dz"
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
    logfc_cutoff: 0.028  # Standard: ~222 genes (top 25%)
    percentile_filtering:
      enabled: false
      threshold: 75
    pval_key: null
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"

# Strict fold-change threshold profile for Arthritis
CMAP_Arthritis_Strict:
  paths:
    signatures: "data/drug_signatures/cmap_signatures.RData"
    disease_file: "data/disease_signatures/arthritis_signature.csv"
    drug_meta: "data/drug_signatures/cmap_drug_experiments_new.csv"
    drug_valid: "data/drug_signatures/cmap_valid_instances.csv"
    out_dir: "results"
  params:
    gene_key: "gene_symbol"
    logfc_cols_pref: "logfc_dz"
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
    logfc_cutoff: 0.04  # Strict: ~133 genes
    pval_key: null
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"


# ============================================================================
# GLAUCOMA PROFILES (CMAP Database)
# ============================================================================

# Lenient fold-change threshold profile for Glaucoma
CMAP_Glaucoma_Lenient:
  paths:
    signatures: "data/drug_signatures/cmap_signatures.RData"
    disease_file: "data/disease_signatures/glaucoma_signature.csv"
    drug_meta: "data/drug_signatures/cmap_drug_experiments_new.csv"
    drug_valid: "data/drug_signatures/cmap_valid_instances.csv"
    out_dir: "results"
  params:
    gene_key: "gene_symbol"
    logfc_cols_pref: "logfc_dz"
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
    logfc_cutoff: 0.033  # Lenient: ~229 genes
    pval_key: null
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"

# Standard fold-change threshold profile for Glaucoma
CMAP_Glaucoma_Standard:
  paths:
    signatures: "data/drug_signatures/cmap_signatures.RData"
    disease_file: "data/disease_signatures/glaucoma_signature.csv"
    drug_meta: "data/drug_signatures/cmap_drug_experiments_new.csv"
    drug_valid: "data/drug_signatures/cmap_valid_instances.csv"
    out_dir: "results"
  params:
    gene_key: "gene_symbol"
    logfc_cols_pref: "logfc_dz"
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
    logfc_cutoff: 0.047  # Standard: ~115 genes (top 25%)
    percentile_filtering:
      enabled: false
      threshold: 75
    pval_key: null
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"

# Strict fold-change threshold profile for Glaucoma
CMAP_Glaucoma_Strict:
  paths:
    signatures: "data/drug_signatures/cmap_signatures.RData"
    disease_file: "data/disease_signatures/glaucoma_signature.csv"
    drug_meta: "data/drug_signatures/cmap_drug_experiments_new.csv"
    drug_valid: "data/drug_signatures/cmap_valid_instances.csv"
    out_dir: "results"
  params:
    gene_key: "gene_symbol"
    logfc_cols_pref: "logfc_dz"
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
    logfc_cutoff: 0.06  # Strict: ~69 genes
    pval_key: null
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"


# ============================================================================
# TAHOE PROFILES (TAHOE Drug Signature Database)
# ============================================================================

# Lenient fold-change threshold profile for Acne (TAHOE)
TAHOE_Acne_Lenient:
  paths:
    signatures: "data/drug_signatures/tahoe_signatures.RData"
    disease_file: "data/disease_signatures/acne_signature.csv"
    drug_meta: "data/drug_signatures/tahoe_drug_experiments_new.csv"
    drug_valid: null
    out_dir: "results"
  params:
    gene_key: "gene_symbol"
    logfc_cols_pref: "logfc_dz"
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
    logfc_cutoff: null
    percentile_filtering:
      enabled: true
      threshold: 25  # Keep top 75% of genes by |logFC|
    pval_key: null
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"

# Standard fold-change threshold profile for Acne (TAHOE)
TAHOE_Acne_Standard:
  paths:
    signatures: "data/drug_signatures/tahoe_signatures.RData"
    disease_file: "data/disease_signatures/acne_signature.csv"
    drug_meta: "data/drug_signatures/tahoe_drug_experiments_new.csv"
    drug_valid: null
    out_dir: "results"
  params:
    gene_key: "gene_symbol"
    logfc_cols_pref: "logfc_dz"
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
    logfc_cutoff: null
    percentile_filtering:
      enabled: true
      threshold: 50  # Keep top 50% of genes by |logFC|
    pval_key: null
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"

# Strict fold-change threshold profile for Acne (TAHOE)
TAHOE_Acne_Strict:
  paths:
    signatures: "data/drug_signatures/tahoe_signatures.RData"
    disease_file: "data/disease_signatures/acne_signature.csv"
    drug_meta: "data/drug_signatures/tahoe_drug_experiments_new.csv"
    drug_valid: null
    out_dir: "results"
  params:
    gene_key: "gene_symbol"
    logfc_cols_pref: "logfc_dz"
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
    logfc_cutoff: null
    percentile_filtering:
      enabled: true
      threshold: 75  # Keep top 25% of genes by |logFC|
    pval_key: null
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"

# Lenient fold-change threshold profile for Arthritis (TAHOE)
TAHOE_Arthritis_Lenient:
  paths:
    signatures: "data/drug_signatures/tahoe_signatures.RData"
    disease_file: "data/disease_signatures/arthritis_signature.csv"
    drug_meta: "data/drug_signatures/tahoe_drug_experiments_new.csv"
    drug_valid: null
    out_dir: "results"
  params:
    gene_key: "gene_symbol"
    logfc_cols_pref: "logfc_dz"
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
    logfc_cutoff: null
    percentile_filtering:
      enabled: true
      threshold: 25  # Keep top 75% of genes by |logFC|
    pval_key: null
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"

# Standard fold-change threshold profile for Arthritis (TAHOE)
TAHOE_Arthritis_Standard:
  paths:
    signatures: "data/drug_signatures/tahoe_signatures.RData"
    disease_file: "data/disease_signatures/arthritis_signature.csv"
    drug_meta: "data/drug_signatures/tahoe_drug_experiments_new.csv"
    drug_valid: null
    out_dir: "results"
  params:
    gene_key: "gene_symbol"
    logfc_cols_pref: "logfc_dz"
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
    logfc_cutoff: null
    percentile_filtering:
      enabled: true
      threshold: 50  # Keep top 50% of genes by |logFC|
    pval_key: null
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"

# Strict fold-change threshold profile for Arthritis (TAHOE)
TAHOE_Arthritis_Strict:
  paths:
    signatures: "data/drug_signatures/tahoe_signatures.RData"
    disease_file: "data/disease_signatures/arthritis_signature.csv"
    drug_meta: "data/drug_signatures/tahoe_drug_experiments_new.csv"
    drug_valid: null
    out_dir: "results"
  params:
    gene_key: "gene_symbol"
    logfc_cols_pref: "logfc_dz"
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
    logfc_cutoff: null
    percentile_filtering:
      enabled: true
      threshold: 75  # Keep top 25% of genes by |logFC|
    pval_key: null
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"

# Lenient fold-change threshold profile for Glaucoma (TAHOE)
TAHOE_Glaucoma_Lenient:
  paths:
    signatures: "data/drug_signatures/tahoe_signatures.RData"
    disease_file: "data/disease_signatures/glaucoma_signature.csv"
    drug_meta: "data/drug_signatures/tahoe_drug_experiments_new.csv"
    drug_valid: null
    out_dir: "results"
  params:
    gene_key: "gene_symbol"
    logfc_cols_pref: "logfc_dz"
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
    logfc_cutoff: null
    percentile_filtering:
      enabled: true
      threshold: 25  # Keep top 75% of genes by |logFC|
    pval_key: null
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"

# Standard fold-change threshold profile for Glaucoma (TAHOE)
TAHOE_Glaucoma_Standard:
  paths:
    signatures: "data/drug_signatures/tahoe_signatures.RData"
    disease_file: "data/disease_signatures/glaucoma_signature.csv"
    drug_meta: "data/drug_signatures/tahoe_drug_experiments_new.csv"
    drug_valid: null
    out_dir: "results"
  params:
    gene_key: "gene_symbol"
    logfc_cols_pref: "logfc_dz"
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
    logfc_cutoff: null
    percentile_filtering:
      enabled: true
      threshold: 50  # Keep top 50% of genes by |logFC|
    pval_key: null
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"

# Strict fold-change threshold profile for Glaucoma (TAHOE)
TAHOE_Glaucoma_Strict:
  paths:
    signatures: "data/drug_signatures/tahoe_signatures.RData"
    disease_file: "data/disease_signatures/glaucoma_signature.csv"
    drug_meta: "data/drug_signatures/tahoe_drug_experiments_new.csv"
    drug_valid: null
    out_dir: "results"
  params:
    gene_key: "gene_symbol"
    logfc_cols_pref: "logfc_dz"
    gene_conversion_table: "data/gene_id_conversion_table.tsv"
    logfc_cutoff: null
    percentile_filtering:
      enabled: true
      threshold: 75  # Keep top 25% of genes by |logFC|
    pval_key: null
    pval_cutoff: 0.05
    q_thresh: 0.05
    reversal_only: true
    seed: 123
    mode: "single"
